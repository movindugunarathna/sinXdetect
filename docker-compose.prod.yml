# filepath: c:\Users\movin\FYP\sinXdetect\docker-compose.prod.yml
# SinXdetect Production Docker Compose
#
# Usage:
#   docker compose -f docker-compose.prod.yml up --build -d --remove-orphans
#   docker compose -f docker-compose.prod.yml down --remove-orphans
#
# Production URLs:
#   - Frontend: https://sinxdetect.movindu.com
#   - Backend API: https://api.sinxdetect.movindu.com

services:
  # Combined sinXdetect Application (Frontend + Backend)
  # Uses the unified multi-stage Dockerfile
  sinxdetect:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://api.sinxdetect.movindu.com
        - NODE_ENV=production
    container_name: sinxdetect-app-prod
    ports:
      - '80:80'
      - '443:443'
    volumes:
      # Mount SSL certificates from Let's Encrypt
      - /etc/letsencrypt:/etc/letsencrypt:ro
    environment:
      - MODEL_PATH=/app/ml/models/sinbert_sinhala_classifier
      - PYTHONUNBUFFERED=1
      - UVICORN_WORKERS=2
      - NODE_ENV=production
    networks:
      - sinxdetect-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--quiet',
          '--tries=1',
          '--spider',
          'http://localhost:80/',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

networks:
  sinxdetect-network:
    driver: bridge
